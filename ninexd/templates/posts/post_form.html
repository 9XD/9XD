{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
    <!-- TODO It needs refactor -->
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.8/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/vue.resource/1.0.3/vue-resource.min.js"></script>
    <style type="text/css">
        html, body, #editor {
            margin: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: #333;
        }

        textarea, #editor div {
            display: inline-block;
            width: 49%;
            height: 100%;
            vertical-align: top;
            box-sizing: border-box;
            padding: 0 20px;
        }

        textarea {
            border: none;
            border-right: 1px solid #ccc;
            resize: none;
            outline: none;
            background-color: #f6f6f6;
            font-size: 14px;
            font-family: 'Monaco', courier, monospace;
            padding: 20px;
            min-height:600px;
        }

        code {
            color: #f66;
        }
    </style>

    <form action="{% url 'posts:create' %}" method="post">
        {% csrf_token %}
        <div id="div_id_title" class="form-group">
            <label for="id_title" class="form-control-label  requiredField">
                Title<span class="asteriskField">*</span>
            </label>
            <div class="">
                <input class="textinput textInput form-control" id="id_title" maxlength="60" name="title" type="text"
                       required="">
            </div>
        </div>
        <div id="div_id_content" class="form-group">
            <label for="id_content" class="form-control-label  requiredField">
                Content<span class="asteriskField">*</span>
            </label>
            <div id="editor" class="">
                <textarea :value="input" @input="update" id="id_content" name="content" required=""></textarea>

                <div v-html="compiledMarkdown"></div>
            </div>
        </div>
        <div id="div_id_tags" class="form-group">
            <label for="id_tags" class="form-control-label  requiredField">
                Tags<span class="asteriskField">*</span>
            </label>
            <div class="">
                <input class="textinput textInput form-control" id="id_tags" name="tags" type="text" required="">
            </div>
        </div>
        <div class="form-group">
            <div id="div_id_is_public" class="checkbox">
                <label for="id_is_public" class="">
                    <input checked="checked" class="checkboxinput" id="id_is_public" name="is_public" type="checkbox">
                    Is public
                </label>
            </div>
        </div>
        <button class="btn btn-primary" type="submit">Write</button>
    </form>


    <script>
      new Vue({
        el: '#editor',
        data: {
          input: '# hello'
        },
        computed: {
          compiledMarkdown: function () {
            const form_data = new FormData();
            form_data.append('text', this.input);
            const options = {
                headers: {
                    "X-CSRFToken": document.getElementsByName('csrfmiddlewaretoken')[0].value,
                },
                body:{
                    text: this.input
                }
            };
            const cm = this;
            this.$http.post('/common/convert-markdown', form_data, options)
                .then(function (response) {
                    cm.response = response.data;
                }, function (response) {
                    return response.data;
                });

            return cm.response;
          }
        },
        methods: {
          update: _.debounce(function (e) {
            this.input = e.target.value
          }, 300)
        }
      })
    </script>


{% endblock %}
